{% extends "templates/web.html" %}

{% block header %}
<h1 style="margin-top: 10px; font-size: 24px;">{{ doc.name }}</h1>
{% endblock %}

{% block script %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const makeQuotationBtn = document.querySelector(".btn.btn-primary.btn-sm");

    if (makeQuotationBtn) {
        makeQuotationBtn.addEventListener("click", function() {
            // Select all rate input fields (if editable)
            let rates = document.querySelectorAll(".rfq-items input[name='rate'], .rfq-items .rate-value");
            alert("rates ....",rates)
            let hasValidItem = false;
            rates.forEach(rateInput => {
                alert("in .......")
                let value = parseFloat(rateInput.value || rateInput.innerText || 0);
                alert("value .....",value)
                if (value > 0) {
                    hasValidItem = true;
                }
            });

            if (!hasValidItem) {
                frappe.msgprint({
                    title: __("Error"),
                    message: __("Please enter rate greater than 0 for at least one item before submitting quotation."),
                    indicator: "red"
                });
                return; // stop further action
            }

            // ✅ Proceed to create quotation
            // You can redirect or trigger quotation creation here
            frappe.call({
                method: "your_app.api.create_supplier_quotation",
                args: {
                    rfq_name: "{{ doc.name }}"
                },
                callback: function(r) {
                    if (!r.exc) {
                        frappe.msgprint("Quotation created successfully!");
                        window.location.reload();
                    }
                }
            });
        });
    }
});
</script>
{% endblock %}

{% block breadcrumbs %}
	{% include "templates/includes/breadcrumbs.html" %}
{% endblock %}

{% block header_actions %}
{% if doc.items %}
<button class="btn btn-primary btn-sm" type="button">
    {{ _("Make Quotation") }}
</button>
{% endif %}
{% endblock %}

{% block page_content %}
<div class="row">
    <div class="col-6">
        <div class="rfq-supplier"><strong>Supplier:</strong> {{ doc.supplier or "-" }}</div>
	</div>
    <div class="col-6 text-muted text-right h6">
        <strong>Transaction Date:</strong> {{ doc.get_formatted("transaction_date") or "-" }}
    </div>
</div>

<!-- ✅ Required Date -->
<div class="row mt-3">
    <div class="col-6">
        <strong>Required Date:</strong>
        {% if doc.items %}
            {% for item in doc.items %}
                <div>{{ item.item_name or "-" }} : {{ item.schedule_date or "-" }}</div>
            {% endfor %}
        {% else %}
            <div>-</div>
        {% endif %}
    </div>
</div>

<div class="rfq-content" style="margin-top:15px">
	<div id="order-container">
		<div id="rfq-items">
			<div class="row cart-item-header">
				<div class="col-sm-5 col-12">{{ _("Items") }}</div>
				<div class="col-sm-2 col-4 text-right">{{ _("Qty") }}</div>
				<div class="col-sm-2 col-4 text-right">{{ _("Rate") }}</div>
				<div class="col-sm-3 col-4 text-right">{{ _("Amount") }}</div>
			</div>
			<hr>
            {% if doc.items %}
            <div class="rfq-items">
				{% include "templates/includes/rfq/rfq_items.html" %}
            </div>
            {% endif %}
		</div>
        {% if doc.items %}
		<div class="row grand-total-row">
			<div class="col-9 text-right">{{ _("Grand Total") }}</div>
			<div class="col-3 text-right">
				{{ doc.currency_symbol or "" }} <span class="tax-grand-total">0.0</span>
			</div>
		</div>
        {% endif %}
        <hr>

        <div class="row terms" style="margin-top: -40px;">
			<div class="col-6">
				<br><br>
				<p><strong>{{ _("Notes: ") }}</strong></p>
				<textarea class="form-control terms-feedback" style="height: 100px;"></textarea>
			</div>
		</div>
        <hr>

        <div class="row mt-3">
            <div class="col-12">
                <strong>Terms & Conditions:</strong>
                <div class="text-muted mt-1">
                    {{ doc.terms or doc.terms_html or "-" }}
                </div>
            </div>
        </div> 
    </div>
</div>
{% endblock %}
